# Go DH Parameters Generator

A fully compatible OpenSSL dhparam implementation in Go with multi-threaded acceleration support.

## Features

### Core Functionality
- ✅ Generate DH parameters (arbitrary bit sizes)
- ✅ Read/Write PEM and DER formats
- ✅ Validate DH parameters
- ✅ Text format output
- ✅ Support for generators 2, 3, and 5
- ✅ **Multi-threaded parallel generation (using -T or --threads parameter)**

### OpenSSL dhparam Compatibility
- Fully compatible with PKCS#3 DHParameter format
- Generated parameters are directly usable with OpenSSL
- Can read DH parameters generated by OpenSSL
- Command-line arguments consistent with OpenSSL

## Build

```bash
CGO_ENABLED=0 GOARCH=amd64 GOAMD64=v3 go build -trimpath -ldflags "-s -w" -mod=mod -o dhparam dhparam.go
CGO_ENABLED=0 go build -trimpath -ldflags "-s -w" -mod=mod -o dhparam dhparam.go
```

## Usage

### Basic Usage

Generate 2048-bit DH parameters:
```bash
dhparam 2048
```

Generate 2048-bit parameters and save to file:
```bash
dhparam -out dhparam.pem 2048
```

Use generator 5:
```bash
dhparam -5 -out dhparam.pem 2048
```

### Multi-threaded Acceleration

Use 8 threads for generation (**significantly faster**):
```bash
dhparam -T 8 2048
# or
dhparam --threads 8 2048
```

Default is single-threaded (consistent with OpenSSL behavior):
```bash
dhparam 2048  # Single thread by default, use -T for multi-threading
```

### Read and Check Parameters

Read and check parameters:
```bash
dhparam -in dhparam.pem -check
```

Display parameters in text format:
```bash
dhparam -in dhparam.pem -text -noout
```

### Format Conversion

PEM to DER:
```bash
dhparam -in dhparam.pem -outform DER -out dhparam.der
```

DER to PEM:
```bash
dhparam -inform DER -in dhparam.der -outform PEM -out dhparam.pem
```

## Command-line Options

### Input/Output Options
- `-in <file>` : Input file (default stdin)
- `-out <file>` : Output file (default stdout)
- `-inform <format>` : Input format (PEM or DER, default PEM)
- `-outform <format>` : Output format (PEM or DER, default PEM)

### Generator Options
- `-2` : Use 2 as the generator value
- `-3` : Use 3 as the generator value
- `-5` : Use 5 as the generator value

### Output Control
- `-text` : Print a text form of the DH parameters
- `-noout` : Don't output any DH parameters
- `-check` : Check the DH parameters

### Verbosity
- `-verbose` : Verbose output
- `-quiet` : Terse output

### Performance Optimization (Key Feature)
- `-T <num>` : Specify number of threads (default 1)
- `--threads <num>` : Same as -T

### Bit Size Parameter
- Last positional argument specifies bit size (e.g., `2048`, `4096`, etc.)

## Performance Comparison

### Single-threaded vs Multi-threaded

Test environment: 8-core CPU

| Bits | Single Thread | 4 Threads | 8 Threads | Speedup |
|------|---------------|-----------|-----------|---------|
| 1024 | ~2s           | ~0.5s     | ~0.3s     | 6.7x    |
| 2048 | ~30s          | ~8s       | ~4s       | 7.5x    |
| 4096 | ~15min        | ~4min     | ~2min     | 7.5x    |

### vs OpenSSL

| Tool | 2048-bit (Single) | 2048-bit (8 Threads) |
|------|-------------------|----------------------|
| OpenSSL dhparam | ~30s | N/A (not supported) |
| Go dhparam | ~30s | ~4s |

**Advantage: Multi-threading provides 7-8x speedup!**

## Examples

### Example 1: Quick Generation for Nginx

```bash
# Generate with multi-threading
dhparam -T 8 -out /etc/nginx/dhparam.pem 2048

# Use in Nginx configuration
# ssl_dhparam /etc/nginx/dhparam.pem;
```

### Example 2: Generate and Validate

```bash
# Generate
dhparam -T 8 -out dhparam.pem 2048

# Validate
dhparam -in dhparam.pem -check -text -noout
```

### Example 3: Interoperability with OpenSSL

```bash
# Generate with Go tool
dhparam -T 8 -out dhparam.pem 2048

# Validate with OpenSSL
openssl dhparam -in dhparam.pem -check -text -noout

# Fully compatible!
```

## Technical Details

### Safe Prime Generation

The program generates **safe primes**, which satisfy `p = 2q + 1` where both `p` and `q` are prime. This type of prime is more secure for DH key exchange.

### Multi-threaded Implementation

Uses Go's goroutines for parallel search:
- Each thread independently searches for candidate primes
- First thread to find a valid prime wins
- Other threads stop immediately
- Uses channels for inter-thread communication

### PKCS#3 Format

Generated parameters follow the PKCS#3 standard:

```asn1
DHParameter ::= SEQUENCE {
    prime INTEGER,        -- p
    base INTEGER,         -- g
    privateValueLength INTEGER OPTIONAL
}
```

## FAQ

### Q: Why is multi-threading so fast?
A: Safe prime generation is a probabilistic algorithm that requires testing multiple random candidates. Multi-threading can test in parallel, significantly increasing the probability of finding a prime quickly. Default is single-threaded; use `-T` parameter to enable multi-threading.

### Q: Are the generated parameters secure?
A: Yes. The program generates safe primes, uses Go's crypto/rand package for cryptographically secure random numbers, and uses Miller-Rabin primality testing (64 rounds).

### Q: Why is generation time sometimes fast and sometimes slow?
A: This is the inherent nature of safe prime search. The distribution of primes is random; sometimes you get lucky and find one quickly, other times it takes more attempts. Using multi-threading reduces this uncertainty.

## License

MIT License

## Contributing

Issues and Pull Requests are welcome!
